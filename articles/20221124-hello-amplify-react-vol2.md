---
title: "ã€React/GraphQLã€‘Amplifyã‚’ä½¿ã£ã¦GraphQLç’°å¢ƒã®æ§‹ç¯‰ãƒãƒ³ã‚ºã‚ªãƒ³ vol.2 | Offers Tech Blog"
emoji: "ğŸ–‹ï¸"
type: "tech"
topics:
  - "graphql"
  - "react"
  - "amplify"
published: true
published_at: "2022-11-24 09:00"
publication_name: "overflow_offers"
---

# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ï¼

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºäººæã®å‰¯æ¥­è»¢è·ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  [Offers](https://offers.jp/) ã‚’é‹å–¶ã™ã‚‹æ ªå¼ä¼šç¤¾ [overflow](https://overflow.co.jp/) ã§ Offers ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’é–‹ç™ºã—ã¦ã„ã‚‹ [fumiya](https://twitter.com/fumiya_itsc) ã§ã™ã€‚

10 æœˆ 1 æ—¥ã‹ã‚‰ Flexible ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦é€± 3 ã§åƒã‹ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã€ç¿Œæœˆã® 11 æœˆ 16 æ—¥ã‹ã‚‰ã¯æ­£å¼ã« Full ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦å‚ç”»ã•ã›ã¦ã„ãŸã ãã¾ã™ï¼

# æ¦‚è¦

ã“ã®è¨˜äº‹ã¯ React ã¨ [Amplify](https://aws.amazon.com/jp/amplify/) ã‚’ä½¿ã£ã¦é–‹ç™ºã™ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ•´ãˆã‚‹è¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚


åˆ†é‡ãŒå¤šããªã£ãŸãŸã‚ã€[vol.1](https://zenn.dev/offers/articles/20221121-hello-amplify-react-vol1) ã¨ vol2 ã«åˆ†ã‘ã¦ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚

React ã¨ Amplify ã ã‘ã§ã‚‚é–‹ç™ºã‚’å§‹ã‚ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ãŒã€åŠ¹ç‡çš„ã«é–‹ç™ºã‚’é€²ã‚ã‚‹ãŸã‚ã« [GraphQL Code Generator](https://www.the-guild.dev/graphql/codegen) ã‚„ [TanStack Query](https://tanstack.com/query/v4/) ã‚’å–ã‚Šå…¥ã‚Œã€
ä¼¼ãŸã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ¸›ã‚‰ã—ã€é–‹ç™ºè€…ä½“é¨“ã‚’è‰¯ãã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ã¦ã€å°‘ã—ã§ã‚‚æ¥½ã«é–‹ç™ºã—ã¦ã„ãã“ã¨ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«é–‹ç™ºç’°å¢ƒã‚’äº‹å‰ã«æ•´ãˆã‚‹ã“ã¨ãŒã“ã®è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚

æµã‚Œã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

1. Amplify API ã¨ Auth ã‚’ä½¿ã£ã¦ GraphQL ã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰(vol.1)
1. React hooks ã‚’ä½¿ã„ã€GraphQL ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ç”»é¢ã«è¡¨ç¤ºã™ã‚‹(vol.1)
1. GraphQL ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ GraphQL Code Generator ã¨ TanStack Query ã‚’ä½¿ã£ã¦å®£è¨€çš„ã«æ›¸ã(æœ¬è¨˜äº‹)

ãƒãƒ³ã‚ºã‚ªãƒ³ã§ç™»å ´ã™ã‚‹æŠ€è¡“ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

- Amplify API
- Amplify Auth
- React
- GraphQL Code Generator
- TanStack Query

:::message
React ã‚’ç”¨ã„ã¦é€²ã‚ã¾ã™ãŒç´¹ä»‹ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æ§˜ã€…ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦èª­ã¿æ›¿ãˆã¦ã„ãŸã ã‘ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚
:::

## 1. TanStack Query ã®å°å…¥

ã•ã£ãã TanStack Query ã®å°å…¥ã—ãŸã„ã¨ã“ã‚ã§ã™ãŒ vol.1 ã§å°‘ã—è¤‡é›‘ã«ãªã£ãŸå‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

ã“ã“ã§ã¯ TodoList.tsx ã‚’ä½œã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¯ã®å½¹å‰²ã‚’åˆ†ã‘ã¾ã™ã€‚

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

```:terminal
touch src/TodoList.tsx
```

Todo ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚„æç”»å‘¨ã‚Šã¯ TodoList.tsx ã«å¼•ã£è¶Šã—ã¾ã™ã€‚

```jsx:src/TodoList.tsx
import { GraphQLResult } from "@aws-amplify/api-graphql";
import { listTodos } from "./graphql/queries";
import { useEffect, useState } from "react";
import { ListTodosQuery } from "./API";
import { API } from "aws-amplify";

export const TodoList = () => {
  const [todoList, setTodoList] = useState<ListTodosQuery | undefined>();
  useEffect(() => {
    const fetchTodos = async () => {
      const todos = (await API.graphql({
        query: listTodos,
      })) as GraphQLResult<ListTodosQuery>;
      setTodoList(todos.data);
    };
    fetchTodos();
  }, []);
  return (
    <div>
      {todoList?.listTodos?.items.map((item) => {
        return (
          <>
            <div>id: {item?.id}</div>
            <div>name: {item?.name}</div>
            <div>desc: {item?.description}</div>
            <div>createdAt: {item?.createdAt}</div>
            <div>updatedAt: {item?.updatedAt}</div>
            <br />
          </>
        );
      })}
    </div>
  );
};
```

```diff jsx:src/App.tsx
- import { Amplify, API, Auth } from "aws-amplify";
- import { GraphQLResult } from "@aws-amplify/api-graphql";
- import { listTodos } from "./graphql/queries";
- import { useEffect, useState } from "react";
- import { ListTodosQuery } from "./API";
+ import { Amplify, Auth } from "aws-amplify";
+ import { TodoList } from "./TodoList";

import { withAuthenticator } from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

import awsExports from "./aws-exports";
Amplify.configure(awsExports);

const App = () => {
-   const [todoList, setTodoList] = useState<ListTodosQuery | undefined>();
-   useEffect(() => {
-     const fetchTodos = async () => {
-       const todos = (await API.graphql({
-         query: listTodos,
-       })) as GraphQLResult<ListTodosQuery>;
-       setTodoList(todos.data);
-     };
-     fetchTodos();
-   }, []);
-
-   return (
-     <>
-       <h1>Hello Amplify</h1>
-       {todoList?.listTodos?.items.map((item) => {
-         return (
-           <>
-             <div>id: {item?.id}</div>
-             <div>name: {item?.name}</div>
-             <div>desc: {item?.description}</div>
-             <div>createdAt: {item?.createdAt}</div>
-             <div>updatedAt: {item?.updatedAt}</div>
-             <br />
-           </>
-         );
-       })}
+   return (
+     <>
+       <h1>Hello Amplify and TanStack Query</h1>
+       <TodoList />
      <button
        onClick={() => {
          Auth.signOut();
        }}
      >
        Sign out
      </button>
    </>
  );
};

export default withAuthenticator(App);
```

ã“ã‚Œã§ App.tsx ã‹ã‚‰ Todo é–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢ã§ãã¾ã—ãŸã€‚

ç¶ºéº—ã«åˆ†é›¢ã§ããŸã¨ã“ã‚ã§ TanStack Queryï¼ˆå…ƒ React Queryï¼‰ã‚’å°å…¥ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### TanStack Query ã®å°å…¥

TanStack Query ã‚’å°å…¥ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å®£è¨€çš„ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ãŒè‰¯ããªã‚Šã¾ã™ã€‚

ã¾ãšã¯å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚

```:terminal
npm i @tanstack/react-query
```

æ¬¡ã« TanStack Query ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã§ä½¿ãˆã‚‹ã‚ˆã†ã« QueryClient ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚Šã€App ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ QueryClientProvider ã§æ‹¬ã£ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚

```diff jsx:src/App.tsx
import { Amplify, Auth } from "aws-amplify";
import { TodoList } from "./TodoList";

+ import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

import { withAuthenticator } from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

import awsExports from "./aws-exports";
Amplify.configure(awsExports);

+ const queryClient = new QueryClient();

const App = () => {
  return (
-     <>
+     <QueryClientProvider client={queryClient}>
        <h1>Hello Amplify and TanStack Query</h1>
        <TodoList />
        <button
          onClick={() => {
            Auth.signOut();
          }}
        >
          Sign out
        </button>
+     </QueryClientProvider>
-     </>
  );
};

export default withAuthenticator(App);
```

TanStack Query ã‚’ä½¿ã†æº–å‚™ãŒå‡ºæ¥ãŸã®ã§ã€æ—©é€Ÿ Todo ã®ä¸€è¦§ã‚’ TanStack Query ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```diff jsx:src/TodoList.tsx
import { GraphQLResult } from "@aws-amplify/api-graphql";
import { listTodos } from "./graphql/queries";
- import { useEffect, useState } from "react";
import { ListTodosQuery } from "./API";
import { API } from "aws-amplify";
+ import { useQuery } from "@tanstack/react-query";

+ const fetchTodos = async () => {
+   const todos = (await API.graphql({
+     query: listTodos,
+   })) as GraphQLResult<ListTodosQuery>;
+   return todos;
+ };

export const TodoList = () => {
-   const [todoList, setTodoList] = useState<ListTodosQuery | undefined>();
-   useEffect(() => {
-     const fetchTodos = async () => {
-       const todos = (await API.graphql({
-         query: listTodos,
-       })) as GraphQLResult<ListTodosQuery>;
-       setTodoList(todos.data);
-     };
-     fetchTodos();
-   }, []);
  const todoList = useQuery(["todoList"], fetchTodos);

  return (
    <div>
-     {todoList?.listTodos?.items.map((item) => {
-       return (
+     {todoList.data?.data?.listTodos?.items.map((item) => (
        <>
          <div>id: {item?.id}</div>
          <div>name: {item?.name}</div>
          <div>desc: {item?.description}</div>
          <div>createdAt: {item?.createdAt}</div>
          <div>updatedAt: {item?.updatedAt}</div>
          <br />
        </>
-       );
-     })}
+     ))}
    </div>
  );
};
```

TanStack Query ã‚’å°å…¥ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ useState ã‚„ useEffect ãŒ TodoList ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰æ¶ˆãˆã¦ã€`useQuery(["todoList"], fetchTodos)` ã«é›†ç´„ã•ã‚Œã¾ã—ãŸã€‚
ã“ã“ã« GraphQL Code Generator ã‚’å°å…¥ã—ã¦æŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿æ“ä½œã‚’å®Ÿç¾ã—ã¾ã—ã‚‡ã†ã€‚

## 2. GraphQL Code Generator ã®å°å…¥

æ¬¡ã¯ GraphQL Code Generator ã‚’å°å…¥ã—ã¦ã„ãã¾ã™ã€‚

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```:terminal
npm install graphql
npm install -D @graphql-codegen/client-preset @graphql-codegen/cli @graphql-codegen/introspection @graphql-codegen/typescript-react-query
```

æ¬¡ã« `graphql-code-generator init` ã‚’å®Ÿè¡Œã—ã¦å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```:terminal
amplify_graphqlcodegenerator_template â¯â¯â¯ npx graphql-code-generator init

    Welcome to GraphQL Code Generator!
    Answer few questions and we will setup everything for you.

? What type of application are you building? Application built with React
? Where is your schema?: (path or url) src/graphql/schema.json
? Where are your operations and fragments?: src/graphql-codegen/**/*.graphql
? Where to write the output: src/generated/graphql.ts
? Do you want to generate an introspection file? Yes
? How to name the config file? codegen.ts
? What script in package.json should run the codegen? codegen
Fetching latest versions of selected plugins...

    Config file generated at codegen.ts

      $ npm install

    To install the plugins.

      $ npm run codegen

    To run GraphQL Code Generator.
```

ç”Ÿæˆã•ã‚ŒãŸ codegen.ts ã‚’é–‹ãã€plugin ã‚’è¿½åŠ ã—ã¾ã™ã€‚

:::message alert
ç­†è€…ã®ç’°å¢ƒã§è©¦ã—ãŸã¨ã“ã‚ã€`preset: "client"` ã®è¨­å®šã§ç”Ÿæˆã•ã‚Œã‚‹æ–‡ã¨å¾Œã»ã©åŠ ãˆã‚‹ `plugin` ã§ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ãŒç«¶åˆã—ã¦ã—ã¾ã†ãƒã‚°ï¼ŸãŒã‚ã£ãŸãŸã‚ã€ã“ã“ã§ã¯å›é¿ç­–ã¨ã—ã¦ `preset: "client"` ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€`preset: "client"` ã§ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦èª¿ã¹ãŸã®ã§ã™ãŒæ­£ç›´ã‚ˆãåˆ†ã‹ã£ã¦ãŠã‚‰ãšæœ‰è­˜è€…ã®æ–¹ãŒã„ãŸã‚‰æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
:::

```diff js:codegen.js
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  overwrite: true,
  schema: "./src/graphql/schema.json",
  documents: "src/graphql-codegen/**/*.graphql",
  generates: {
    "src/generated/graphql.ts": {
-     preset: "client",
      plugins: [
+       "typescript",
+       "typescript-operations",
+       "typescript-react-query",
      ],
    },
    "./graphql.schema.json": {
      plugins: ["introspection"],
    },
  },
};

export default config;
```

æ¬¡ã« graphql ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
graphql-codegen ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œã‚Šã€graphql ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```:terminal
mkdir src/graphql-codegen
touch src/graphql-codegen/todo.graphql
```

todo.graphql ã«å–å¾—ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ã¡ãªã¿ã«ç­†è€…ã¯ Amplify ã§ generate ã•ã‚ŒãŸ src/graphql/å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¿…è¦ãªãƒ¢ãƒã‚’ã‚³ãƒ”ãƒšã—ã¦å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ®‹ã™ã‚ˆã†ã«ä¿®æ­£ã—ã¦ä½¿ã£ã¦ã„ã¾ã™ã€‚

```graphql:src/graphql-codegen/todo.graphql
query ListTodos(
  $filter: ModelTodoFilterInput
  $limit: Int
  $nextToken: String
) {
  listTodos(filter: $filter, limit: $limit, nextToken: $nextToken) {
    items {
      id
      name
      description
      createdAt
      updatedAt
    }
    nextToken
  }
}
```

ã“ã‚Œã§å¤§æ–¹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

GraphQL Code Generator ã§ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```:terminal
npm run codegen
```

ã“ã‚Œã§ generated/graphql.ts ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```diff:tree
amplify_graphqlcodegenerator_template â¯â¯â¯ tree ./src -L 2
./src
â”œâ”€â”€ API.ts
â”œâ”€â”€ App.css
â”œâ”€â”€ App.test.tsx
â”œâ”€â”€ App.tsx
â”œâ”€â”€ TodoList.tsx
â”œâ”€â”€ aws-exports.js
+â”œâ”€â”€ generated
+â”‚   â””â”€â”€ graphql.ts
â”œâ”€â”€ graphql
â”‚   â”œâ”€â”€ mutations.ts
â”‚   â”œâ”€â”€ queries.ts
â”‚   â”œâ”€â”€ schema.json
â”‚   â””â”€â”€ subscriptions.ts
â”œâ”€â”€ graphql-codegen
â”‚   â”œâ”€â”€ customFetcher.ts
â”‚   â””â”€â”€ todo.graphql
â”œâ”€â”€ index.css
â”œâ”€â”€ index.tsx
â”œâ”€â”€ logo.svg
â”œâ”€â”€ react-app-env.d.ts
â”œâ”€â”€ reportWebVitals.ts
â””â”€â”€ setupTests.ts
```

ç”Ÿæˆã•ã‚ŒãŸ graphql.ts ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
å…ˆç¨‹å®šç¾©ã—ãŸ `todo.graphql` ã‚’å…ƒã« `useListTodosQuery` é–¢æ•°ãŒä½œã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```js:src/generated/graphql.ts
~~~~~~~~~~~~çœç•¥~~~~~~~~~~~~
export const useListTodosQuery = <TData = ListTodosQuery, TError = unknown>(
  dataSource: { endpoint: string; fetchParams?: RequestInit },
  variables?: ListTodosQueryVariables,
  options?: UseQueryOptions<ListTodosQuery, TError, TData>
) =>
  useQuery<ListTodosQuery, TError, TData>(
    variables === undefined ? ["ListTodos"] : ["ListTodos", variables],
    fetcher<ListTodosQuery, ListTodosQueryVariables>(
      dataSource.endpoint,
      dataSource.fetchParams || {},
      ListTodosDocument,
      variables
    ),
    options
  );
```

ã•ã£ããä½¿ã£ã¦ã¿ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ã“ã® useOOO ã‚’ä½¿ã†ãŸã³ã« `dataSource: { endpoint: string; fetchParams?: RequestInit }` ã‚’è¦æ±‚ã•ã‚Œã‚‹ã®ã¯é¢å€’ã§ã™ã€‚

graphql code generator ã® custom fetcher ã®æ©Ÿèƒ½ã‚’ä½¿ã„ã€`dataSource` ã‚’æ¯å›æ›¸ã‹ãªãã¦ã‚‚æ¸ˆã‚€ã‚ˆã†ã«ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```:terminal
touch src/graphql-codegen/customFetcher.ts
```

GraphQL ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```js:src/graphql-codegen/customFetcher.ts
import { API, GraphQLResult } from "@aws-amplify/api";

export const fetchWithAmplify = <TData, TVariables>(
  query: string,
  variables?: TVariables
): (() => Promise<TData>) => {
  return async () => {
    const result = await (API.graphql({
      query,
      variables: variables || {},
      authMode: "AMAZON_COGNITO_USER_POOLS",
    }) as Promise<GraphQLResult<TData>>);

    if (result.errors) {
      const message = result.errors
        ? result.errors[0].message
        : "GraphQL fetching error";
      throw new Error(message);
    }

    return result.data!;
  };
};
```

`@aws-amplify/api` ã‚’ä½¿ã†ã“ã¨ã«ã‚ˆã£ã¦èªè¨¼å‘¨ã‚Šã§æ¥½ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã« custom fetcher ã‚’ä½¿ã†ã“ã¨ã‚’ graphql code generator ã®è¨­å®šã«æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```js diff:codegen.ts
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  overwrite: true,
  schema: "src/graphql/schema.json",
  documents: "src/graphql-codegen/**/*.graphql",
  generates: {
    "src/generated/graphql.ts": {
      plugins: [
        "typescript",
        "typescript-operations",
        "typescript-react-query",
      ],
+     config: {
+       fetcher: "../graphql-codegen/customFetcher#fetchWithAmplify",
+     },
    },
    "./graphql.schema.json": {
      plugins: ["introspection"],
    },
  },
};

export default config;
```

æ°—ã‚’ã¤ã‘ãŸã„ã®ãŒ fetcher ã® value ã¯ config ã‹ã‚‰ã¿ãŸç›¸å¯¾ãƒ‘ã‚¹ã§ã¯ãªãã€ç”Ÿæˆã•ã‚Œã‚‹ `src/generated/graphql.ts` ã‹ã‚‰ã¿ãŸç›¸å¯¾ãƒ‘ã‚¹ã§ã‚ã‚‹ã“ã¨ã¨ã€#ä»¥é™ã«è‡ªåˆ†ã§å®Ÿè£…ã—ãŸé–¢æ•°ã®åå‰ã‚’æ›¸ãã“ã¨ã§ã™ã€‚

ã“ã“ã¾ã§å‡ºæ¥ãŸã‚‰å†åº¦ graphql code generator ã‚’å‹•ã‹ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```:terminal
npm run codegen
```

ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ã¿ã¦ã¿ã‚‹ã¨ã€å®Ÿè£…ã—ãŸ `fetchWithAmplify` ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```js:src/graphql-codegen/customFetcher.ts
import { useQuery, UseQueryOptions } from '@tanstack/react-query';
import { fetchWithAmplify } from '../graphql-codegen/customFetcher';

~~~~~~~~~~~~çœç•¥~~~~~~~~~~~~
export const useListTodosQuery = <
      TData = ListTodosQuery,
      TError = unknown
    >(
      variables?: ListTodosQueryVariables,
      options?: UseQueryOptions<ListTodosQuery, TError, TData>
    ) =>
    useQuery<ListTodosQuery, TError, TData>(
      variables === undefined ? ['ListTodos'] : ['ListTodos', variables],
      fetchWithAmplify<ListTodosQuery, ListTodosQueryVariables>(ListTodosDocument, variables),
      options
    );
```

æœ€å¾Œã« `TodoList.tsx` å†…ã§ `useListTodosQuery` ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—å‡ºæ¥ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```js diff:src/TodoList.tsx
+import { useListTodosQuery } from "./generated/graphql";
-import { GraphQLResult } from "@aws-amplify/api-graphql";
-import { listTodos } from "./graphql/queries";
-import { ListTodosQuery } from "./API";
-import { API } from "aws-amplify";
-import { useQuery } from "@tanstack/react-query";
-
-const fetchTodos = async () => {
-  const todos = (await API.graphql({
-    query: listTodos,
-  })) as GraphQLResult<ListTodosQuery>;
-  return todos;
-};


export const TodoList = () => {
- const todoList = useQuery(["todoList"], fetchTodos);
+ const { data } = useListTodosQuery();

  return (
    <div>
-     {todoList.data?.data?.listTodos?.items.map((item) => (
+     {data?.listTodos?.items.map((item) => (
        <>
          <div>id: {item?.id}</div>
          <div>name: {item?.name}</div>
          <div>desc: {item?.description}</div>
          <div>createdAt: {item?.createdAt}</div>
          <div>updatedAt: {item?.updatedAt}</div>
          <br />
        </>
      ))}
    </div>
  );
};
```

![Hello Amplifyã‹ã‚™è¡¨ç¤ºã•ã‚ŒãŸç”»é¢ã®ç”»åƒ](/images/20221124-hello-amplify-react-vol2/01.png)

è¡¨ç¤ºã¯ä»Šã¾ã§ã¨å¤‰ã‚ã‚‰ãªã„ã‚‚ã®ã® `TodoList.tsx` ãŒ `useListTodosQuery` ã ã‘ã«ä¾å­˜ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã€ã¨ã¦ã‚‚è¦‹é€šã—ãŒè‰¯ããªã‚Šã¾ã—ãŸã€‚

# ã¾ã¨ã‚

é–‹ç™ºè€…ä½“é¨“ã‚’è‰¯ãã™ã‚‹ãŸã‚ã« GraphQL Code Generator ã¨ TanStack Query ã‚’ Amplify ã¨ React ã®ç’°å¢ƒã«å°å…¥ã—ã¦ãã¾ã—ãŸã€‚

é–‹ç™ºã‚’é€²ã‚ã¦ã„ãä¸­ã§ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã ã‘ã§ãªã Todo ã®ä½œæˆã‚‚å¿…è¦ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãã†ã„ã†ã¨ãã¯ `src/graphql-codegen/todo.graphql` ã« mutation ã‚’æ›¸ã„ã¦ã‚ã’ã‚Œã° `useCreateTodoMutation` ãŒç°¡å˜ã«æ‰‹ã«å…¥ã‚Šã¾ã™ã€‚

ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã§é–‹ç™ºã‚’é€²ã‚ã¦ã„ã‘ã°åŠ¹ç‡çš„ã«ä¿å®ˆæ€§ã®é«˜ã„ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒå‡ºæ¥ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã®è¨˜äº‹ãŒçš†ã•ã‚“ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

æœ€å¾Œã«ã¯ãªã‚Šã¾ã™ãŒã€æœ¬è¨˜äº‹ã‚’æœ€å¾Œã¾ã§èª­ã‚“ã§é ‚ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã€Œ**ã“ã‚“ãªè¨˜äº‹ã‚’æ›¸ã„ã¦ã»ã—ã„ï¼**ã€ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚


# é–¢é€£è¨˜äº‹

https://zenn.dev/offers/articles/20221017-definition-of-frontend
https://zenn.dev/offers/articles/20220523-component-design-best-practice
https://zenn.dev/offers/articles/20220418-what-is-bff-architecture

[^1]: Amplify CLI ã®è¨­å®šã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚https://docs.amplify.aws/cli/start/install/#option-2-follow-the-instructions/
[^2]: ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶å¾¡ã—ãŸã„å ´åˆã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚https://docs.amplify.aws/cli/graphql/authorization-rules/
[^3]: ãƒ‡ãƒ¼ã‚¿ã® CRUD æ“ä½œã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚https://docs.amplify.aws/lib/graphqlapi/mutate-data/q/platform/js/
